@model Escale.Web.Models.CustomerDetailsViewModel
@{
    ViewData["Title"] = "Customer Details";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-user me-2"></i>@Model.Customer.Name</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Customers" asp-action="Index">Customers</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Customer.Name</li>
            </ol>
        </nav>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a asp-controller="Customers" asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>
</div>

@await Html.PartialAsync("_ApiError")

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">TOTAL CARS</div>
                        <div class="h4 mb-0 fw-bold">@Model.Customer.Cars.Count</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-car fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">ACTIVE SUBSCRIPTIONS</div>
                        <div class="h4 mb-0 fw-bold">@Model.Customer.Subscriptions.Count(s => s.Status == "Active")</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-star fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">CREDIT LIMIT</div>
                        <div class="h5 mb-0 fw-bold">@Model.Customer.CreditLimit.ToString("N0") RWF</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-credit-card fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">CURRENT CREDIT</div>
                        <div class="h5 mb-0 fw-bold">@Model.Customer.CurrentCredit.ToString("N0") RWF</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="card shadow">
    <div class="card-header" style="background: white; border-bottom: 2px solid var(--border-color);">
        <ul class="nav nav-tabs card-header-tabs border-0" id="customerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                    <i class="fas fa-info-circle me-2"></i>Details
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cars-tab" data-bs-toggle="tab" data-bs-target="#cars" type="button" role="tab">
                    <i class="fas fa-car me-2"></i>Cars <span class="badge bg-primary">@Model.Customer.Cars.Count</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="subscriptions-tab" data-bs-toggle="tab" data-bs-target="#subscriptions" type="button" role="tab">
                    <i class="fas fa-star me-2"></i>Subscriptions <span class="badge bg-success">@Model.Customer.Subscriptions.Count</span>
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="customerTabsContent">
            <!-- Details Tab -->
            <div class="tab-pane fade show active" id="details" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">Personal Information</h5>
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th width="40%">Name:</th>
                                    <td>@Model.Customer.Name</td>
                                </tr>
                                <tr>
                                    <th>Email:</th>
                                    <td>@(Model.Customer.Email ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Phone:</th>
                                    <td>@(Model.Customer.PhoneNumber ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Customer Type:</th>
                                    <td>
                                        <span class="badge @(Model.Customer.Type == "Corporate" ? "bg-primary" : "bg-info")">
                                            @Model.Customer.Type
                                        </span>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrEmpty(Model.Customer.TIN))
                                {
                                    <tr>
                                        <th>TIN:</th>
                                        <td>@Model.Customer.TIN</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3">Account Information</h5>
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th width="40%">Status:</th>
                                    <td>
                                        <span class="badge @(Model.Customer.IsActive ? "bg-success" : "bg-secondary")">
                                            @(Model.Customer.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Credit Limit:</th>
                                    <td>@Model.Customer.CreditLimit.ToString("N0") RWF</td>
                                </tr>
                                <tr>
                                    <th>Current Credit:</th>
                                    <td>
                                        <span class="@(Model.Customer.CurrentCredit > 0 ? "text-danger fw-bold" : "")">
                                            @Model.Customer.CurrentCredit.ToString("N0") RWF
                                        </span>
                                        @if (Model.Customer.CreditLimit > 0)
                                        {
                                            var creditPercent = (Model.Customer.CurrentCredit / Model.Customer.CreditLimit) * 100;
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar @(creditPercent > 80 ? "bg-danger" : creditPercent > 50 ? "bg-warning" : "bg-success")"
                                                     style="width: @creditPercent%"></div>
                                            </div>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <th>Created At:</th>
                                    <td>@Model.Customer.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Cars Tab -->
            <div class="tab-pane fade" id="cars" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Customer Cars</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Plate Number</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>Year</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Customer.Cars.Any())
                            {
                                @foreach (var car in Model.Customer.Cars)
                                {
                                    <tr>
                                        <td><strong>@car.PlateNumber</strong></td>
                                        <td>@(car.Make ?? "N/A")</td>
                                        <td>@(car.Model ?? "N/A")</td>
                                        <td>@(car.Year?.ToString() ?? "N/A")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No cars registered yet</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Subscriptions Tab -->
            <div class="tab-pane fade" id="subscriptions" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Customer Subscriptions</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Fuel Type</th>
                                <th>Monthly Liters</th>
                                <th>Used Liters</th>
                                <th>Usage</th>
                                <th>Price/Liter</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Customer.Subscriptions.Any())
                            {
                                @foreach (var subscription in Model.Customer.Subscriptions)
                                {
                                    var usagePercent = subscription.MonthlyLiters > 0
                                        ? (subscription.UsedLiters / subscription.MonthlyLiters) * 100
                                        : 0;
                                    <tr>
                                        <td><strong>@subscription.FuelTypeName</strong></td>
                                        <td>@subscription.MonthlyLiters.ToString("N1") L</td>
                                        <td>@subscription.UsedLiters.ToString("N1") L</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                    <div class="progress-bar @(usagePercent > 80 ? "bg-danger" : usagePercent > 50 ? "bg-warning" : "bg-success")"
                                                         style="width: @usagePercent%"></div>
                                                </div>
                                                <small>@usagePercent.ToString("N0")%</small>
                                            </div>
                                        </td>
                                        <td>@subscription.PricePerLiter.ToString("N0") RWF</td>
                                        <td>@subscription.StartDate.ToString("yyyy-MM-dd")</td>
                                        <td>@subscription.EndDate.ToString("yyyy-MM-dd")</td>
                                        <td>
                                            @{
                                                var statusClass = subscription.Status switch
                                                {
                                                    "Active" => "bg-success",
                                                    "Expired" => "bg-secondary",
                                                    "Cancelled" => "bg-danger",
                                                    _ => "bg-info"
                                                };
                                            }
                                            <span class="badge @statusClass">@subscription.Status</span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted">No subscriptions found</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // No individual car/subscription CRUD - managed at customer level via API
</script>
}
