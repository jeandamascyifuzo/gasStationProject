@model Escale.Web.Models.CustomerDetailsViewModel
@{
    ViewData["Title"] = "Customer Details";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-user me-2"></i>@Model.Customer.Name</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Customers" asp-action="Index">Customers</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Customer.Name</li>
            </ol>
        </nav>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary me-2" onclick="editCustomer(@Model.Customer.Id)">
            <i class="fas fa-edit me-2"></i>Edit Customer
        </button>
        <a asp-controller="Customers" asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">TOTAL CARS</div>
                        <div class="h4 mb-0 fw-bold">@Model.Stats.TotalCars</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-car fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">ACTIVE SUBSCRIPTIONS</div>
                        <div class="h4 mb-0 fw-bold">@Model.Stats.ActiveSubscriptions</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-star fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">TOTAL SPENT</div>
                        <div class="h5 mb-0 fw-bold">@Model.Stats.TotalSpent.ToString("N0") RWF</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">LAST TRANSACTION</div>
                        <div class="h6 mb-0 fw-bold">
                            @(Model.Stats.LastTransaction?.ToString("MMM dd") ?? "N/A")
                        </div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-calendar fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="card shadow">
    <div class="card-header" style="background: white; border-bottom: 2px solid var(--border-color);">
        <ul class="nav nav-tabs card-header-tabs border-0" id="customerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                    <i class="fas fa-info-circle me-2"></i>Details
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cars-tab" data-bs-toggle="tab" data-bs-target="#cars" type="button" role="tab">
                    <i class="fas fa-car me-2"></i>Cars <span class="badge bg-primary">@Model.Cars.Count</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="subscriptions-tab" data-bs-toggle="tab" data-bs-target="#subscriptions" type="button" role="tab">
                    <i class="fas fa-star me-2"></i>Subscriptions <span class="badge bg-success">@Model.Subscriptions.Count</span>
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="customerTabsContent">
            <!-- Details Tab -->
            <div class="tab-pane fade show active" id="details" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">Personal Information</h5>
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th width="40%">Name:</th>
                                    <td>@Model.Customer.Name</td>
                                </tr>
                                <tr>
                                    <th>Email:</th>
                                    <td>@Model.Customer.Email</td>
                                </tr>
                                <tr>
                                    <th>Phone:</th>
                                    <td>@Model.Customer.Phone</td>
                                </tr>
                                <tr>
                                    <th>Address:</th>
                                    <td>@Model.Customer.Address</td>
                                </tr>
                                <tr>
                                    <th>Customer Type:</th>
                                    <td>
                                        <span class="badge @(Model.Customer.CustomerType == "Corporate" ? "bg-primary" : "bg-info")">
                                            @Model.Customer.CustomerType
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3">Additional Information</h5>
                        <table class="table table-borderless">
                            <tbody>
                                @if (!string.IsNullOrEmpty(Model.Customer.CompanyName))
                                {
                                    <tr>
                                        <th width="40%">Company Name:</th>
                                        <td>@Model.Customer.CompanyName</td>
                                    </tr>
                                }
                                @if (!string.IsNullOrEmpty(Model.Customer.TIN))
                                {
                                    <tr>
                                        <th>TIN:</th>
                                        <td>@Model.Customer.TIN</td>
                                    </tr>
                                }
                                <tr>
                                    <th>Status:</th>
                                    <td>
                                        <span class="badge @(Model.Customer.IsActive ? "bg-success" : "bg-secondary")">
                                            @(Model.Customer.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Created At:</th>
                                    <td>@Model.Customer.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                </tr>
                                @if (Model.Customer.UpdatedAt.HasValue)
                                {
                                    <tr>
                                        <th>Updated At:</th>
                                        <td>@Model.Customer.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Cars Tab -->
            <div class="tab-pane fade" id="cars" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Customer Cars</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#carModal" onclick="openCarModal()">
                        <i class="fas fa-plus me-2"></i>Add Car
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Plate Number</th>
                                <th>Car PIN</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>Year</th>
                                <th>Color</th>
                                <th>Created At</th>
                                <th>Updated At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Cars.Any())
                            {
                                @foreach (var car in Model.Cars)
                                {
                                    <tr>
                                        <td><strong>@car.PlateNumber</strong></td>
                                        <td>@car.CarPin</td>
                                        <td>@car.Make</td>
                                        <td>@car.Model</td>
                                        <td>@car.Year</td>
                                        <td>@car.Color</td>
                                        <td>@car.CreatedAt.ToString("yyyy-MM-dd")</td>
                                        <td>@(car.UpdatedAt?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="editCar(@car.Id)" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteCar(@car.Id)" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="9" class="text-center text-muted">No cars registered yet</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Subscriptions Tab -->
            <div class="tab-pane fade" id="subscriptions" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Customer Subscriptions</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#subscriptionModal" onclick="openSubscriptionModal()">
                        <i class="fas fa-plus me-2"></i>Add Subscription
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Fuel Type</th>
                                <th>Monthly Limit</th>
                                <th>Current Usage</th>
                                <th>Payment Frequency</th>
                                <th>Status</th>
                                <th>Activated Date</th>
                                <th>Expiry Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Subscriptions.Any())
                            {
                                @foreach (var subscription in Model.Subscriptions)
                                {
                                    <tr>
                                        <td><strong>@subscription.SubscriptionType</strong></td>
                                        <td>@subscription.Amount.ToString("N0") RWF</td>
                                        <td>@subscription.FuelType</td>
                                        <td>@(subscription.MonthlyLimit?.ToString("N0") ?? "N/A") RWF</td>
                                        <td>
                                            @(subscription.CurrentUsage?.ToString("N0") ?? "0") RWF
                                            @if (subscription.MonthlyLimit.HasValue && subscription.CurrentUsage.HasValue)
                                            {
                                                var percentage = (subscription.CurrentUsage.Value / subscription.MonthlyLimit.Value) * 100;
                                                <div class="progress mt-1" style="height: 5px;">
                                                    <div class="progress-bar @(percentage > 80 ? "bg-danger" : percentage > 50 ? "bg-warning" : "bg-success")" 
                                                         style="width: @percentage%"></div>
                                                </div>
                                            }
                                        </td>
                                        <td>@subscription.PaymentFrequency</td>
                                        <td>
                                            <span class="badge @(subscription.IsActive ? "bg-success" : "bg-secondary")">
                                                @(subscription.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </td>
                                        <td>@(subscription.ActivatedDate?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                        <td>@(subscription.ExpiryDate?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="editSubscription(@subscription.Id)" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            @if (subscription.IsActive)
                                            {
                                                <button class="btn btn-sm btn-warning" onclick="cancelSubscription(@subscription.Id)" title="Cancel">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="10" class="text-center text-muted">No subscriptions found</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Car Modal -->
<div class="modal fade" id="carModal" tabindex="-1" aria-labelledby="carModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="carModalLabel">Add/Edit Car</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="carForm" asp-controller="Customers" asp-action="AddCar" method="post">
                <div class="modal-body">
                    <input type="hidden" id="carId" name="Id" />
                    <input type="hidden" name="CustomerId" value="@Model.Customer.Id" />
                    
                    <div class="mb-3">
                        <label for="plateNumber" class="form-label">Plate Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="plateNumber" name="PlateNumber" required placeholder="RAA 123 B" />
                    </div>

                    <div class="mb-3">
                        <label for="carPin" class="form-label">Car PIN <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="carPin" name="CarPin" required placeholder="1234" />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="make" class="form-label">Make</label>
                            <input type="text" class="form-control" id="make" name="Make" placeholder="Toyota" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="model" class="form-label">Model <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="model" name="Model" required placeholder="Camry" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="year" class="form-label">Year</label>
                            <input type="number" class="form-control" id="year" name="Year" placeholder="2020" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color" name="Color" placeholder="Silver" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Car
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Subscription Modal -->
<div class="modal fade" id="subscriptionModal" tabindex="-1" aria-labelledby="subscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="subscriptionModalLabel">Add/Edit Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="subscriptionForm" asp-controller="Customers" asp-action="AddSubscription" method="post">
                <div class="modal-body">
                    <input type="hidden" id="subscriptionId" name="Id" />
                    <input type="hidden" name="CustomerId" value="@Model.Customer.Id" />
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="subscriptionType" class="form-label">Subscription Type <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="subscriptionType" name="SubscriptionType" required placeholder="Premium Monthly" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="amount" name="Amount" required placeholder="50000" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fuelType" class="form-label">Fuel Type</label>
                            <select class="form-select" id="fuelType" name="FuelType">
                                <option value="">Select Fuel Type</option>
                                <option value="Petrol">Petrol</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Super">Super</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="paymentFrequency" class="form-label">Payment Frequency</label>
                            <select class="form-select" id="paymentFrequency" name="PaymentFrequency">
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Yearly">Yearly</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="monthlyLimit" class="form-label">Monthly Limit (RWF)</label>
                            <input type="number" class="form-control" id="monthlyLimit" name="MonthlyLimit" placeholder="100000" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="activatedDate" class="form-label">Activated Date</label>
                            <input type="date" class="form-control" id="activatedDate" name="ActivatedDate" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date</label>
                            <input type="date" class="form-control" id="expiryDate" name="ExpiryDate" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="isActiveSubscription" name="IsActive" checked />
                                <label class="form-check-label" for="isActiveSubscription">
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Subscription
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function editCustomer(id) {
        // TODO: Load customer data via AJAX
        alert('Edit customer functionality - to be implemented with modal');
    }

    function openCarModal() {
        $('#carForm').attr('action', '@Url.Action("AddCar", "Customers")');
        $('#carModalLabel').text('Add New Car');
        $('#carForm')[0].reset();
        $('#carId').val('');
        $('input[name="CustomerId"]').val(@Model.Customer.Id);
    }

    function editCar(id) {
        // TODO: Load car data via AJAX
        $('#carForm').attr('action', '@Url.Action("EditCar", "Customers")');
        $('#carModalLabel').text('Edit Car');
        $('#carId').val(id);
        $('#carModal').modal('show');
    }

    function deleteCar(id) {
        if (confirm('Are you sure you want to delete this car?')) {
            $.post('@Url.Action("DeleteCar", "Customers")', { id: id, customerId: @Model.Customer.Id }, function() {
                location.reload();
            });
        }
    }

    function openSubscriptionModal() {
        $('#subscriptionForm').attr('action', '@Url.Action("AddSubscription", "Customers")');
        $('#subscriptionModalLabel').text('Add New Subscription');
        $('#subscriptionForm')[0].reset();
        $('#subscriptionId').val('');
        $('input[name="CustomerId"]').val(@Model.Customer.Id);
    }

    function editSubscription(id) {
        // TODO: Load subscription data via AJAX
        $('#subscriptionForm').attr('action', '@Url.Action("EditSubscription", "Customers")');
        $('#subscriptionModalLabel').text('Edit Subscription');
        $('#subscriptionId').val(id);
        $('#subscriptionModal').modal('show');
    }

    function cancelSubscription(id) {
        if (confirm('Are you sure you want to cancel this subscription?')) {
            $.post('@Url.Action("CancelSubscription", "Customers")', { id: id, customerId: @Model.Customer.Id }, function() {
                location.reload();
            });
        }
    }
</script>
}
