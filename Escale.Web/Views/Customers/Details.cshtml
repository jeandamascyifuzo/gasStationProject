@model Escale.Web.Models.CustomerDetailsViewModel
@{
    ViewData["Title"] = "Customer Details";
    var activeSub = Model.Customer.Subscriptions.FirstOrDefault(s => s.Status == "Active");
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-user me-2"></i>@Model.Customer.Name</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Customers" asp-action="Index">Customers</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Customer.Name</li>
            </ol>
        </nav>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a asp-controller="Customers" asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>
</div>

@await Html.PartialAsync("_ApiError")

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">TOTAL CARS</div>
                        <div class="h4 mb-0 fw-bold">@Model.Customer.Cars.Count</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-car fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">SUBSCRIPTION BALANCE</div>
                        <div class="h5 mb-0 fw-bold">
                            @(activeSub != null ? activeSub.RemainingBalance.ToString("N0") + " RWF" : "No Active")
                        </div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">CREDIT LIMIT</div>
                        <div class="h5 mb-0 fw-bold">@Model.Customer.CreditLimit.ToString("N0") RWF</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-credit-card fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">CURRENT CREDIT</div>
                        <div class="h5 mb-0 fw-bold">@Model.Customer.CurrentCredit.ToString("N0") RWF</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="card shadow">
    <div class="card-header" style="background: white; border-bottom: 2px solid var(--border-color);">
        <ul class="nav nav-tabs card-header-tabs border-0" id="customerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                    <i class="fas fa-info-circle me-2"></i>Details
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cars-tab" data-bs-toggle="tab" data-bs-target="#cars" type="button" role="tab">
                    <i class="fas fa-car me-2"></i>Cars <span class="badge bg-primary">@Model.Customer.Cars.Count</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="subscriptions-tab" data-bs-toggle="tab" data-bs-target="#subscriptions" type="button" role="tab">
                    <i class="fas fa-wallet me-2"></i>Subscriptions <span class="badge bg-success">@Model.Customer.Subscriptions.Count</span>
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="customerTabsContent">
            <!-- Details Tab -->
            <div class="tab-pane fade show active" id="details" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">Personal Information</h5>
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th width="40%">Name:</th>
                                    <td>@Model.Customer.Name</td>
                                </tr>
                                <tr>
                                    <th>Email:</th>
                                    <td>@(Model.Customer.Email ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Phone:</th>
                                    <td>@(Model.Customer.PhoneNumber ?? "N/A")</td>
                                </tr>
                                <tr>
                                    <th>Customer Type:</th>
                                    <td>
                                        <span class="badge @(Model.Customer.Type == "Corporate" ? "bg-primary" : "bg-info")">
                                            @Model.Customer.Type
                                        </span>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrEmpty(Model.Customer.TIN))
                                {
                                    <tr>
                                        <th>TIN:</th>
                                        <td>@Model.Customer.TIN</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3">Account Information</h5>
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <th width="40%">Status:</th>
                                    <td>
                                        <span class="badge @(Model.Customer.IsActive ? "bg-success" : "bg-secondary")">
                                            @(Model.Customer.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Credit Limit:</th>
                                    <td>@Model.Customer.CreditLimit.ToString("N0") RWF</td>
                                </tr>
                                <tr>
                                    <th>Current Credit:</th>
                                    <td>
                                        <span class="@(Model.Customer.CurrentCredit > 0 ? "text-danger fw-bold" : "")">
                                            @Model.Customer.CurrentCredit.ToString("N0") RWF
                                        </span>
                                        @if (Model.Customer.CreditLimit > 0)
                                        {
                                            var creditPercent = (Model.Customer.CurrentCredit / Model.Customer.CreditLimit) * 100;
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar @(creditPercent > 80 ? "bg-danger" : creditPercent > 50 ? "bg-warning" : "bg-success")"
                                                     style="width: @creditPercent%"></div>
                                            </div>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <th>Created At:</th>
                                    <td>@Model.Customer.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Cars Tab -->
            <div class="tab-pane fade" id="cars" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Customer Cars</h5>
                    <button type="button" class="btn btn-sm btn-primary" onclick="openAddCarModal()">
                        <i class="fas fa-plus me-2"></i>Add Car
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Plate Number</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>Year</th>
                                <th>Status</th>
                                <th style="width: 140px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Customer.Cars.Any())
                            {
                                @foreach (var car in Model.Customer.Cars)
                                {
                                    <tr>
                                        <td><strong>@car.PlateNumber</strong></td>
                                        <td>@(car.Make ?? "N/A")</td>
                                        <td>@(car.Model ?? "N/A")</td>
                                        <td>@(car.Year?.ToString() ?? "N/A")</td>
                                        <td>
                                            <span class="badge @(car.IsActive ? "bg-success" : "bg-secondary")">
                                                @(car.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" title="Edit"
                                                    onclick="openEditCarModal('@car.Id', '@car.PlateNumber', '@car.Make', '@car.Model', '@car.Year')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            @if (car.IsActive)
                                            {
                                                <form asp-action="DeactivateCar" method="post" class="d-inline"
                                                      onsubmit="return confirm('Deactivate this car?')">
                                                    <input type="hidden" name="customerId" value="@Model.Customer.Id" />
                                                    <input type="hidden" name="carId" value="@car.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Deactivate">
                                                        <i class="fas fa-ban"></i>
                                                    </button>
                                                </form>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">No cars registered yet. Add a car to get started.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Subscriptions Tab -->
            <div class="tab-pane fade" id="subscriptions" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Subscriptions</h5>
                    <button type="button" class="btn btn-sm btn-primary" onclick="openTopUpModal()">
                        <i class="fas fa-plus-circle me-2"></i>Top Up
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Top Up</th>
                                <th>Total Balance</th>
                                <th>Remaining</th>
                                <th>Usage</th>
                                <th>Start Date</th>
                                <th>Expiry</th>
                                <th>Status</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Customer.Subscriptions.Any())
                            {
                                @foreach (var sub in Model.Customer.Subscriptions.OrderByDescending(s => s.CreatedAt))
                                {
                                    var usagePercent = sub.TotalAmount > 0
                                        ? ((sub.TotalAmount - sub.RemainingBalance) / sub.TotalAmount) * 100
                                        : 0;
                                    <tr>
                                        <td><strong>@sub.TopUpAmount.ToString("N0") RWF</strong></td>
                                        <td>@sub.TotalAmount.ToString("N0") RWF</td>
                                        <td>
                                            <span class="@(sub.RemainingBalance > 0 ? "text-success fw-bold" : "text-muted")">
                                                @sub.RemainingBalance.ToString("N0") RWF
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                    <div class="progress-bar @(usagePercent > 80 ? "bg-danger" : usagePercent > 50 ? "bg-warning" : "bg-success")"
                                                         style="width: @usagePercent%"></div>
                                                </div>
                                                <small>@usagePercent.ToString("N0")%</small>
                                            </div>
                                        </td>
                                        <td>@sub.StartDate.ToString("yyyy-MM-dd")</td>
                                        <td>@(sub.ExpiryDate?.ToString("yyyy-MM-dd") ?? "No Expiry")</td>
                                        <td>
                                            @{
                                                var statusClass = sub.Status switch
                                                {
                                                    "Active" => "bg-success",
                                                    "Inactive" => "bg-secondary",
                                                    "Expired" => "bg-warning",
                                                    "Cancelled" => "bg-danger",
                                                    _ => "bg-info"
                                                };
                                            }
                                            <span class="badge @statusClass">@sub.Status</span>
                                        </td>
                                        <td>
                                            @if (sub.Status == "Active")
                                            {
                                                <form asp-action="CancelSubscription" method="post" class="d-inline"
                                                      onsubmit="return confirm('Cancel this subscription? Remaining balance: @sub.RemainingBalance.ToString("N0") RWF')">
                                                    <input type="hidden" name="customerId" value="@Model.Customer.Id" />
                                                    <input type="hidden" name="subscriptionId" value="@sub.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Cancel">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </form>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-3">No subscriptions yet. Click "Top Up" to create one.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Car Modal -->
<div class="modal fade" id="addCarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="carModalTitle">Add Car</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="carForm" asp-action="AddCar" method="post">
                <div class="modal-body">
                    <input type="hidden" name="customerId" value="@Model.Customer.Id" />
                    <input type="hidden" id="carId" name="carId" />
                    <div class="mb-3">
                        <label for="carPlateNumber" class="form-label">Plate Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="carPlateNumber" name="plateNumber" required
                               placeholder="e.g. RAD 123 A" />
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="carMake" class="form-label">Make</label>
                            <input type="text" class="form-control" id="carMake" name="make" placeholder="e.g. Toyota" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="carModel" class="form-label">Model</label>
                            <input type="text" class="form-control" id="carModel" name="model" placeholder="e.g. Corolla" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="carYear" class="form-label">Year</label>
                            <input type="number" class="form-control" id="carYear" name="year" min="1990" max="2030"
                                   placeholder="e.g. 2022" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="carPin" class="form-label">PIN <span class="text-danger" id="pinRequired">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control fw-bold font-monospace" id="carPin" name="pin"
                                       maxlength="4" readonly />
                                <button type="button" class="btn btn-outline-secondary" onclick="generatePin()" title="Generate new PIN">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <small class="text-muted" id="pinHint">Auto-generated. Click refresh to regenerate.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i><span id="carSaveBtn">Add Car</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Top Up Subscription Modal -->
<div class="modal fade" id="topUpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Top Up Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="TopUpSubscription" method="post">
                <div class="modal-body">
                    <input type="hidden" name="customerId" value="@Model.Customer.Id" />

                    @if (activeSub != null)
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Current balance: <strong>@activeSub.RemainingBalance.ToString("N0") RWF</strong>.
                            The new top-up will be added to the remaining balance.
                        </div>
                    }

                    <div class="mb-3">
                        <label for="topUpAmount" class="form-label">Top Up Amount (RWF) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="topUpAmount" name="topUpAmount"
                               required min="1" step="100" placeholder="e.g. 50000" />
                    </div>
                    <div class="mb-3">
                        <label for="expiryDate" class="form-label">Expiry Date (Optional)</label>
                        <input type="date" class="form-control" id="expiryDate" name="expiryDate"
                               min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        <small class="text-muted">Leave empty for no expiry</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus-circle me-2"></i>Top Up
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function generatePin() {
        var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        var pin = '';
        for (var i = 0; i < 4; i++) {
            pin += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('carPin').value = pin;
    }

    function openAddCarModal() {
        document.getElementById('carForm').action = '@Url.Action("AddCar", "Customers")';
        document.getElementById('carModalTitle').textContent = 'Add Car';
        document.getElementById('carSaveBtn').textContent = 'Add Car';
        document.getElementById('carId').value = '';
        document.getElementById('carPlateNumber').value = '';
        document.getElementById('carMake').value = '';
        document.getElementById('carModel').value = '';
        document.getElementById('carYear').value = '';
        document.getElementById('carPin').required = true;
        document.getElementById('pinRequired').style.display = '';
        document.getElementById('pinHint').textContent = 'Auto-generated. Click refresh to regenerate.';
        generatePin();
        new bootstrap.Modal(document.getElementById('addCarModal')).show();
    }

    function openEditCarModal(id, plate, make, model, year) {
        document.getElementById('carForm').action = '@Url.Action("UpdateCar", "Customers")';
        document.getElementById('carModalTitle').textContent = 'Edit Car';
        document.getElementById('carSaveBtn').textContent = 'Update Car';
        document.getElementById('carId').value = id;
        document.getElementById('carPlateNumber').value = plate;
        document.getElementById('carMake').value = make === 'null' ? '' : make;
        document.getElementById('carModel').value = model === 'null' ? '' : model;
        document.getElementById('carYear').value = year === 'null' ? '' : year;
        document.getElementById('carPin').value = '';
        document.getElementById('carPin').required = false;
        document.getElementById('pinRequired').style.display = 'none';
        document.getElementById('pinHint').textContent = 'Leave blank to keep current PIN. Click refresh to set new one.';
        new bootstrap.Modal(document.getElementById('addCarModal')).show();
    }

    function openTopUpModal() {
        document.getElementById('topUpAmount').value = '';
        document.getElementById('expiryDate').value = '';
        new bootstrap.Modal(document.getElementById('topUpModal')).show();
    }
</script>
}
