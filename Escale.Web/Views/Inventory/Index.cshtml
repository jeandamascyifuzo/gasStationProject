@model Escale.Web.Models.InventoryViewModel
@{
    ViewData["Title"] = "Inventory";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-boxes me-2"></i>Inventory Management</h1>
        <p class="text-muted mb-0">Monitor fuel stock levels and manage refills across all stations.</p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#refillModal">
            <i class="fas fa-plus me-2"></i>Record Refill
        </button>
    </div>
</div>

@await Html.PartialAsync("_ApiError")

<!-- Station Filter -->
<div class="row mb-4">
    <div class="col-md-4">
        <form method="get" asp-action="Index">
            <div class="input-group">
                <label class="input-group-text"><i class="fas fa-filter"></i></label>
                <select class="form-select" name="stationId" onchange="this.form.submit()">
                    <option value="">All Stations</option>
                    @foreach (var station in Model.Stations)
                    {
                        <option value="@station.Id" selected="@(Model.SelectedStationId == station.Id ? "selected" : null)">@station.Name</option>
                    }
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">TOTAL ITEMS</div>
                        <div class="h4 mb-0 fw-bold">@Model.Stats.TotalItems</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">LOW STOCK</div>
                        <div class="h4 mb-0 fw-bold">@Model.Stats.LowStockItems</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">CRITICAL</div>
                        <div class="h4 mb-0 fw-bold">@Model.Stats.CriticalItems</div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white shadow stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs mb-1">STOCK LEVEL</div>
                        <div class="h4 mb-0 fw-bold">
                            @(Model.Stats.TotalCapacity > 0 ? (Model.Stats.TotalCurrentStock / Model.Stats.TotalCapacity * 100).ToString("F1") : "0.0")%
                        </div>
                    </div>
                    <div class="icon-wrapper">
                        <i class="fas fa-chart-pie fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Stock Levels -->
<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-warehouse me-2"></i>Current Stock Levels</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="inventoryTable" class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Station</th>
                        <th>Fuel Type</th>
                        <th>Current Level</th>
                        <th>Capacity</th>
                        <th>Stock %</th>
                        <th>Reorder Level</th>
                        <th>Status</th>
                        <th>Last Refill</th>
                        <th>Next Delivery</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.InventoryItems)
                    {
                        <tr class="@(item.Status == "Critical" ? "table-danger" : item.Status == "Low Stock" ? "table-warning" : "")">
                            <td>@item.StationName</td>
                            <td>
                                <span class="badge @(item.FuelType == "Petrol" ? "bg-success" : item.FuelType == "Diesel" ? "bg-primary" : "bg-warning")">
                                    @item.FuelType
                                </span>
                            </td>
                            <td><strong>@item.CurrentLevel.ToString("N0")L</strong></td>
                            <td>@item.Capacity.ToString("N0")L</td>
                            <td>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar @(item.IsLowStock ? "bg-danger" : item.PercentageFull > 70 ? "bg-success" : "bg-warning")"
                                         style="width: @item.PercentageFull%">
                                        @item.PercentageFull.ToString("F1")%
                                    </div>
                                </div>
                            </td>
                            <td>@item.ReorderLevel.ToString("N0")L</td>
                            <td>
                                <span class="badge @(item.Status == "Critical" ? "bg-danger" : item.Status == "Low Stock" ? "bg-warning" : "bg-success")">
                                    @item.Status
                                </span>
                            </td>
                            <td>@(item.LastRefill?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                            <td>@(item.NextDeliveryDate?.ToString("yyyy-MM-dd") ?? "TBD")</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="openReorderModal('@item.Id', '@item.StationName - @item.FuelType', @item.ReorderLevel)" title="Set Reorder Level">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Recent Refills -->
<div class="card shadow">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Refills</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="refillsTable" class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Station</th>
                        <th>Fuel Type</th>
                        <th>Quantity (L)</th>
                        <th>Unit Cost</th>
                        <th>Total Cost</th>
                        <th>Supplier</th>
                        <th>Invoice #</th>
                        <th>Recorded By</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var refill in Model.RecentRefills)
                    {
                        <tr>
                            <td>@refill.RefillDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>@refill.StationName</td>
                            <td>
                                <span class="badge @(refill.FuelType == "Petrol" ? "bg-success" : refill.FuelType == "Diesel" ? "bg-primary" : "bg-warning")">
                                    @refill.FuelType
                                </span>
                            </td>
                            <td>@refill.Quantity.ToString("N0")</td>
                            <td>@refill.UnitCost.ToString("N0") RWF</td>
                            <td><strong>@refill.TotalCost.ToString("N0") RWF</strong></td>
                            <td>@refill.SupplierName</td>
                            <td>@refill.InvoiceNumber</td>
                            <td>@refill.RecordedBy</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Refill Modal -->
<div class="modal fade" id="refillModal" tabindex="-1" aria-labelledby="refillModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="refillModalLabel">Record Fuel Refill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="refillForm" asp-controller="Inventory" asp-action="RecordRefill" method="post">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="inventoryItemId" class="form-label">Inventory Item <span class="text-danger">*</span></label>
                            <select class="form-select" id="inventoryItemId" name="inventoryItemId" required>
                                <option value="">Select Inventory Item</option>
                                @foreach (var item in Model.InventoryItems)
                                {
                                    <option value="@item.Id">@item.StationName - @item.FuelType (@item.CurrentLevel.ToString("N0")L / @item.Capacity.ToString("N0")L)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="quantity" class="form-label">Quantity (Liters) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="quantity" name="quantity" required step="0.01" min="0.01" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="unitCost" class="form-label">Unit Cost (RWF) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="unitCost" name="unitCost" required step="0.01" min="0.01" onchange="calculateTotalCost()" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="totalCostDisplay" class="form-label">Total Cost (RWF)</label>
                            <input type="number" class="form-control" id="totalCostDisplay" readonly />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="supplierName" class="form-label">Supplier Name</label>
                            <input type="text" class="form-control" id="supplierName" name="supplierName" placeholder="Rwanda Fuel Ltd" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="invoiceNumber" class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" id="invoiceNumber" name="invoiceNumber" placeholder="INV-2024-001" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="refillDate" class="form-label">Refill Date <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" id="refillDate" name="refillDate" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Record Refill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reorder Level Modal -->
<div class="modal fade" id="reorderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Reorder Level</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-controller="Inventory" asp-action="UpdateReorderLevel" method="post">
                <div class="modal-body">
                    <input type="hidden" name="id" id="reorderItemId" />
                    <p class="text-muted">Item: <strong id="reorderItemName"></strong></p>
                    <div class="mb-3">
                        <label for="reorderLevel" class="form-label">Reorder Level (Liters) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="reorderLevel" name="reorderLevel" required step="1" min="0" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        $('#inventoryTable').DataTable({
            pageLength: 10,
            order: [[6, 'desc']]
        });

        $('#refillsTable').DataTable({
            pageLength: 10,
            order: [[0, 'desc']]
        });

        $('#refillDate').val(new Date().toISOString().slice(0, 16));
    });

    function calculateTotalCost() {
        var quantity = parseFloat($('#quantity').val()) || 0;
        var unitCost = parseFloat($('#unitCost').val()) || 0;
        var totalCost = quantity * unitCost;
        $('#totalCostDisplay').val(totalCost.toFixed(2));
    }

    $('#quantity').on('change keyup', calculateTotalCost);

    function openReorderModal(id, name, currentLevel) {
        $('#reorderItemId').val(id);
        $('#reorderItemName').text(name);
        $('#reorderLevel').val(currentLevel);
        $('#reorderModal').modal('show');
    }
</script>
}
