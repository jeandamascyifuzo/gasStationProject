@model Escale.Web.Models.ReportViewModel
@{
    ViewData["Title"] = "Reports";
}

@await Html.PartialAsync("_ApiError")

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-chart-bar me-2"></i>Reports & Analytics</h1>
        <p class="text-muted mb-0">Generate comprehensive reports and analyze business performance.</p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-success" onclick="exportReport()">
            <i class="fas fa-file-excel me-2"></i>Export
        </button>
    </div>
</div>

<!-- Report Filters -->
<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Report Filters</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="reportType" class="form-label">Report Type</label>
                <select class="form-select" id="reportType" onchange="changeReportType()">
                    <option value="Sales">Sales Report</option>
                    <option value="Inventory">Inventory Report</option>
                    <option value="Employee">Employee Performance</option>
                    <option value="Customer">Customer Report</option>
                    <option value="Financial">Financial Report</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2 mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2 mb-3">
                <label for="stationFilter" class="form-label">Station</label>
                <select class="form-select" id="stationFilter">
                    <option value="">All Stations</option>
                    @foreach (var station in Model.Stations)
                    {
                        <option value="@station.Id">@station.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-2 mb-3" id="fuelTypeFilter">
                <label for="fuelType" class="form-label">Fuel Type</label>
                <select class="form-select" id="fuelType">
                    <option value="">All Fuel Types</option>
                    @foreach (var fuel in Model.FuelTypes)
                    {
                        <option value="@fuel.Id">@fuel.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-1 mb-3 d-flex align-items-end">
                <button type="button" class="btn btn-primary w-100" onclick="generateReport()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Display Area -->
<div class="card shadow">
    <div class="card-header">
        <h5 class="mb-0" id="reportTitle"><i class="fas fa-chart-line me-2"></i>Sales Report</h5>
    </div>
    <div class="card-body">
        <!-- Sales Report -->
        <div id="salesReport">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Select filters and click the search button to generate a report.
            </div>
            <div id="salesReportContent" style="display: none;">
                <!-- Summary Cards -->
                <div class="row mb-4" id="salesSummaryCards">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h6>Total Sales</h6>
                                <h3 id="summaryTotalSales">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h6>Transactions</h6>
                                <h3 id="summaryTransactionCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h6>Period</h6>
                                <h3 id="summaryPeriod">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Sales By Fuel Type -->
                <h6 class="mb-3">Sales by Fuel Type</h6>
                <div class="table-responsive mb-4">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Fuel Type</th>
                                <th>Liters</th>
                                <th>Amount (RWF)</th>
                                <th>Transactions</th>
                            </tr>
                        </thead>
                        <tbody id="salesByFuelBody">
                        </tbody>
                    </table>
                </div>
                <!-- Daily Sales -->
                <h6 class="mb-3">Daily Sales</h6>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount (RWF)</th>
                                <th>Transactions</th>
                            </tr>
                        </thead>
                        <tbody id="dailySalesBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventory Report -->
        <div id="inventoryReport" style="display: none;">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Station</th>
                            <th>Fuel Type</th>
                            <th>Current Level (L)</th>
                            <th>Capacity (L)</th>
                            <th>% Full</th>
                            <th>Status</th>
                            <th>Refill Count</th>
                            <th>Refill Cost (RWF)</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Employee Report -->
        <div id="employeeReport" style="display: none;">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Role</th>
                            <th>Transactions</th>
                            <th>Total Sales (RWF)</th>
                            <th>Shifts</th>
                            <th>Hours Worked</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Customer Report -->
        <div id="customerReport" style="display: none;">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Type</th>
                            <th>Transactions</th>
                            <th>Total Spent (RWF)</th>
                            <th>Total Liters</th>
                            <th>Current Credit (RWF)</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Financial Report -->
        <div id="financialReport" style="display: none;">
            <div id="financialReportContent" style="display: none;">
                <!-- Financial Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h6>Total Revenue</h6>
                                <h3 id="finTotalRevenue">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body text-center">
                                <h6>Total VAT</h6>
                                <h3 id="finTotalVAT">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h6>Refill Cost</h6>
                                <h3 id="finRefillCost">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h6>Gross Profit</h6>
                                <h3 id="finGrossProfit">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Daily Revenue -->
                <h6 class="mb-3">Daily Revenue</h6>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount (RWF)</th>
                                <th>Transactions</th>
                            </tr>
                        </thead>
                        <tbody id="financialTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function changeReportType() {
        var reportType = $('#reportType').val();

        $('#salesReport, #inventoryReport, #employeeReport, #customerReport, #financialReport').hide();

        switch(reportType) {
            case 'Sales':
                $('#reportTitle').html('<i class="fas fa-chart-line me-2"></i>Sales Report');
                $('#salesReport').show();
                $('#fuelTypeFilter').show();
                break;
            case 'Inventory':
                $('#reportTitle').html('<i class="fas fa-boxes me-2"></i>Inventory Report');
                $('#inventoryReport').show();
                $('#fuelTypeFilter').show();
                break;
            case 'Employee':
                $('#reportTitle').html('<i class="fas fa-users me-2"></i>Employee Performance Report');
                $('#employeeReport').show();
                $('#fuelTypeFilter').hide();
                break;
            case 'Customer':
                $('#reportTitle').html('<i class="fas fa-user-friends me-2"></i>Customer Report');
                $('#customerReport').show();
                $('#fuelTypeFilter').hide();
                break;
            case 'Financial':
                $('#reportTitle').html('<i class="fas fa-dollar-sign me-2"></i>Financial Report');
                $('#financialReport').show();
                $('#fuelTypeFilter').hide();
                break;
        }
    }

    function generateReport() {
        var reportType = $('#reportType').val();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        var stationId = $('#stationFilter').val();
        var fuelTypeId = $('#fuelType').val();

        $('.alert-info').hide();

        switch(reportType) {
            case 'Sales':
                generateSalesReport(startDate, endDate, stationId, fuelTypeId);
                break;
            case 'Inventory':
                generateInventoryReport(stationId);
                break;
            case 'Employee':
                generateEmployeeReport(startDate, endDate);
                break;
            case 'Customer':
                generateCustomerReport(startDate, endDate);
                break;
            case 'Financial':
                generateFinancialReport(startDate, endDate);
                break;
        }
    }

    function generateSalesReport(startDate, endDate, stationId, fuelTypeId) {
        $.get('@Url.Action("GenerateSalesReport", "Reports")',
            { startDate: startDate, endDate: endDate, stationId: stationId },
            function(data) {
                if (!data) return;

                // Summary
                $('#summaryTotalSales').text(Number(data.TotalSales).toLocaleString());
                $('#summaryTransactionCount').text(data.TransactionCount);
                var start = new Date(data.StartDate).toLocaleDateString();
                var end = new Date(data.EndDate).toLocaleDateString();
                $('#summaryPeriod').text(start + ' - ' + end).css('font-size', '0.9rem');

                // Sales by Fuel Type
                $('#salesByFuelBody').empty();
                if (data.SalesByFuel) {
                    data.SalesByFuel.forEach(function(item) {
                        $('#salesByFuelBody').append(
                            '<tr>' +
                            '<td><span class="badge bg-primary">' + item.FuelType + '</span></td>' +
                            '<td>' + Number(item.Liters).toLocaleString() + '</td>' +
                            '<td>' + Number(item.Amount).toLocaleString() + '</td>' +
                            '<td>' + item.TransactionCount + '</td>' +
                            '</tr>'
                        );
                    });
                }

                // Daily Sales
                $('#dailySalesBody').empty();
                if (data.DailySales) {
                    data.DailySales.forEach(function(item) {
                        $('#dailySalesBody').append(
                            '<tr>' +
                            '<td>' + new Date(item.Date).toLocaleDateString() + '</td>' +
                            '<td>' + Number(item.Amount).toLocaleString() + '</td>' +
                            '<td>' + item.TransactionCount + '</td>' +
                            '</tr>'
                        );
                    });
                }

                $('#salesReportContent').show();
            }
        ).fail(function() {
            toastr.error('Failed to load sales report.');
        });
    }

    function generateInventoryReport(stationId) {
        $.get('@Url.Action("GenerateInventoryReport", "Reports")',
            { stationId: stationId },
            function(data) {
                $('#inventoryTableBody').empty();
                if (!data) return;
                data.forEach(function(item) {
                    var statusClass = item.Status === 'Critical' ? 'bg-danger' :
                                      item.Status === 'Low' ? 'bg-warning text-dark' : 'bg-success';
                    $('#inventoryTableBody').append(
                        '<tr>' +
                        '<td>' + item.StationName + '</td>' +
                        '<td>' + item.FuelType + '</td>' +
                        '<td>' + Number(item.CurrentLevel).toLocaleString() + '</td>' +
                        '<td>' + Number(item.Capacity).toLocaleString() + '</td>' +
                        '<td>' + Number(item.PercentageFull).toFixed(1) + '%</td>' +
                        '<td><span class="badge ' + statusClass + '">' + item.Status + '</span></td>' +
                        '<td>' + item.RefillCount + '</td>' +
                        '<td>' + Number(item.TotalRefillCost).toLocaleString() + '</td>' +
                        '</tr>'
                    );
                });
            }
        ).fail(function() {
            toastr.error('Failed to load inventory report.');
        });
    }

    function generateEmployeeReport(startDate, endDate) {
        $.get('@Url.Action("GenerateEmployeeReport", "Reports")',
            { startDate: startDate, endDate: endDate },
            function(data) {
                $('#employeeTableBody').empty();
                if (!data) return;
                data.forEach(function(item) {
                    $('#employeeTableBody').append(
                        '<tr>' +
                        '<td>' + item.FullName + '</td>' +
                        '<td><span class="badge bg-primary">' + item.Role + '</span></td>' +
                        '<td>' + item.TransactionCount + '</td>' +
                        '<td>' + Number(item.TotalSales).toLocaleString() + '</td>' +
                        '<td>' + item.ShiftCount + '</td>' +
                        '<td>' + Number(item.TotalHoursWorked).toFixed(1) + '</td>' +
                        '</tr>'
                    );
                });
            }
        ).fail(function() {
            toastr.error('Failed to load employee report.');
        });
    }

    function generateCustomerReport(startDate, endDate) {
        $.get('@Url.Action("GenerateCustomerReport", "Reports")',
            { startDate: startDate, endDate: endDate },
            function(data) {
                $('#customerTableBody').empty();
                if (!data) return;
                data.forEach(function(item) {
                    $('#customerTableBody').append(
                        '<tr>' +
                        '<td>' + item.Name + '</td>' +
                        '<td><span class="badge bg-info">' + item.Type + '</span></td>' +
                        '<td>' + item.TransactionCount + '</td>' +
                        '<td>' + Number(item.TotalSpent).toLocaleString() + '</td>' +
                        '<td>' + Number(item.TotalLiters).toLocaleString() + '</td>' +
                        '<td>' + Number(item.CurrentCredit).toLocaleString() + '</td>' +
                        '</tr>'
                    );
                });
            }
        ).fail(function() {
            toastr.error('Failed to load customer report.');
        });
    }

    function generateFinancialReport(startDate, endDate) {
        $.get('@Url.Action("GenerateFinancialReport", "Reports")',
            { startDate: startDate, endDate: endDate },
            function(data) {
                if (!data) return;

                // Summary cards
                $('#finTotalRevenue').text(Number(data.TotalRevenue).toLocaleString());
                $('#finTotalVAT').text(Number(data.TotalVAT).toLocaleString());
                $('#finRefillCost').text(Number(data.TotalRefillCost).toLocaleString());
                $('#finGrossProfit').text(Number(data.GrossProfit).toLocaleString());

                // Daily Revenue
                $('#financialTableBody').empty();
                if (data.DailyRevenue) {
                    data.DailyRevenue.forEach(function(item) {
                        $('#financialTableBody').append(
                            '<tr>' +
                            '<td>' + new Date(item.Date).toLocaleDateString() + '</td>' +
                            '<td>' + Number(item.Amount).toLocaleString() + '</td>' +
                            '<td>' + item.TransactionCount + '</td>' +
                            '</tr>'
                        );
                    });
                }

                $('#financialReportContent').show();
            }
        ).fail(function() {
            toastr.error('Failed to load financial report.');
        });
    }

    function exportReport() {
        var reportType = $('#reportType').val();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();

        window.location.href = '@Url.Action("ExportReport", "Reports")' +
            '?reportType=' + reportType +
            '&startDate=' + startDate +
            '&endDate=' + endDate;
    }
</script>
}
