@model Escale.Web.Models.ReportViewModel
@{
    ViewData["Title"] = "Reports";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-chart-bar me-2"></i>Reports & Analytics</h1>
        <p class="text-muted mb-0">Generate comprehensive reports and analyze business performance.</p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-success" onclick="exportReport()">
            <i class="fas fa-file-excel me-2"></i>Export
        </button>
    </div>
</div>

<!-- Report Filters -->
<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Report Filters</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="reportType" class="form-label">Report Type</label>
                <select class="form-select" id="reportType" onchange="changeReportType()">
                    <option value="Sales">Sales Report</option>
                    <option value="Inventory">Inventory Report</option>
                    <option value="Employee">Employee Performance</option>
                    <option value="Customer">Customer Report</option>
                    <option value="Financial">Financial Report</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2 mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2 mb-3">
                <label for="stationFilter" class="form-label">Station</label>
                <select class="form-select" id="stationFilter">
                    <option value="">All Stations</option>
                    @foreach (var station in Model.Stations)
                    {
                        <option value="@station.Id">@station.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-2 mb-3" id="fuelTypeFilter">
                <label for="fuelType" class="form-label">Fuel Type</label>
                <select class="form-select" id="fuelType">
                    <option value="">All Fuel Types</option>
                    @foreach (var fuel in Model.FuelTypes)
                    {
                        <option value="@fuel.Id">@fuel.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-1 mb-3 d-flex align-items-end">
                <button type="button" class="btn btn-primary w-100" onclick="generateReport()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Display Area -->
<div class="card shadow">
    <div class="card-header">
        <h5 class="mb-0" id="reportTitle"><i class="fas fa-chart-line me-2"></i>Sales Report</h5>
    </div>
    <div class="card-body">
        <!-- Sales Report -->
        <div id="salesReport">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Select filters and click the search button to generate a report.
            </div>
            <div id="salesReportContent" style="display: none;">
                <div class="table-responsive">
                    <table id="salesTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Station</th>
                                <th>Fuel Type</th>
                                <th>Quantity (L)</th>
                                <th>Total Sales (RWF)</th>
                                <th>Transactions</th>
                                <th>Avg/Transaction</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                        </tbody>
                        <tfoot>
                            <tr class="table-info fw-bold">
                                <td colspan="3">Total</td>
                                <td id="totalQuantity">0</td>
                                <td id="totalSales">0</td>
                                <td id="totalTransactions">0</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventory Report -->
        <div id="inventoryReport" style="display: none;">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Station</th>
                            <th>Fuel Type</th>
                            <th>Opening Stock</th>
                            <th>Received</th>
                            <th>Sold</th>
                            <th>Closing Stock</th>
                            <th>Variance</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Employee Report -->
        <div id="employeeReport" style="display: none;">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Employee</th>
                            <th>Role</th>
                            <th>Station</th>
                            <th>Transactions Processed</th>
                            <th>Total Sales (RWF)</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Customer Report -->
        <div id="customerReport" style="display: none;">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Type</th>
                            <th>Cars</th>
                            <th>Active Subscriptions</th>
                            <th>Total Spent (RWF)</th>
                            <th>Transactions</th>
                            <th>Last Transaction</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Financial Report -->
        <div id="financialReport" style="display: none;">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Revenue</th>
                            <th>Cost of Goods</th>
                            <th>Gross Profit</th>
                            <th>Expenses</th>
                            <th>Net Profit</th>
                            <th>Profit Margin</th>
                        </tr>
                    </thead>
                    <tbody id="financialTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        $('#refillsTable').DataTable({
            pageLength: 10,
            order: [[0, 'desc']]
        });
    });

    function changeReportType() {
        var reportType = $('#reportType').val();
        
        $('#salesReport, #inventoryReport, #employeeReport, #customerReport, #financialReport').hide();
        
        switch(reportType) {
            case 'Sales':
                $('#reportTitle').html('<i class="fas fa-chart-line me-2"></i>Sales Report');
                $('#salesReport').show();
                $('#fuelTypeFilter').show();
                break;
            case 'Inventory':
                $('#reportTitle').html('<i class="fas fa-boxes me-2"></i>Inventory Report');
                $('#inventoryReport').show();
                $('#fuelTypeFilter').show();
                break;
            case 'Employee':
                $('#reportTitle').html('<i class="fas fa-users me-2"></i>Employee Performance Report');
                $('#employeeReport').show();
                $('#fuelTypeFilter').hide();
                break;
            case 'Customer':
                $('#reportTitle').html('<i class="fas fa-user-friends me-2"></i>Customer Report');
                $('#customerReport').show();
                $('#fuelTypeFilter').hide();
                break;
            case 'Financial':
                $('#reportTitle').html('<i class="fas fa-dollar-sign me-2"></i>Financial Report');
                $('#financialReport').show();
                $('#fuelTypeFilter').hide();
                break;
        }
    }

    function generateReport() {
        var reportType = $('#reportType').val();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        var stationId = $('#stationFilter').val();
        var fuelTypeId = $('#fuelType').val();

        $('.alert-info').hide();
        
        switch(reportType) {
            case 'Sales':
                generateSalesReport(startDate, endDate, stationId, fuelTypeId);
                break;
            case 'Inventory':
                generateInventoryReport(startDate, endDate, stationId);
                break;
            case 'Employee':
                generateEmployeeReport(startDate, endDate, stationId);
                break;
            case 'Customer':
                generateCustomerReport(startDate, endDate);
                break;
            case 'Financial':
                generateFinancialReport(startDate, endDate);
                break;
        }
    }

    function generateSalesReport(startDate, endDate, stationId, fuelTypeId) {
        $.get('@Url.Action("GenerateSalesReport", "Reports")', 
            { startDate, endDate, stationId, fuelTypeId }, 
            function(data) {
                $('#salesTableBody').empty();
                var totalQty = 0, totalSales = 0, totalTrans = 0;
                
                data.forEach(function(item) {
                    totalQty += item.quantity;
                    totalSales += item.totalSales;
                    totalTrans += item.transactionCount;
                    
                    $('#salesTableBody').append(
                        '<tr>' +
                        '<td>' + new Date(item.date).toLocaleDateString() + '</td>' +
                        '<td>' + item.station + '</td>' +
                        '<td><span class="badge bg-primary">' + item.fuelType + '</span></td>' +
                        '<td>' + item.quantity.toLocaleString() + '</td>' +
                        '<td>' + item.totalSales.toLocaleString() + '</td>' +
                        '<td>' + item.transactionCount + '</td>' +
                        '<td>' + item.averagePerTransaction.toLocaleString() + '</td>' +
                        '</tr>'
                    );
                });
                
                $('#totalQuantity').text(totalQty.toLocaleString());
                $('#totalSales').text(totalSales.toLocaleString());
                $('#totalTransactions').text(totalTrans);
                
                $('#salesReportContent').show();
            }
        );
    }

    function generateInventoryReport(startDate, endDate, stationId) {
        $.get('@Url.Action("GenerateInventoryReport", "Reports")', 
            { startDate, endDate, stationId }, 
            function(data) {
                $('#inventoryTableBody').empty();
                data.forEach(function(item) {
                    $('#inventoryTableBody').append(
                        '<tr>' +
                        '<td>' + item.station + '</td>' +
                        '<td>' + item.fuelType + '</td>' +
                        '<td>' + item.openingStock.toLocaleString() + '</td>' +
                        '<td>' + item.received.toLocaleString() + '</td>' +
                        '<td>' + item.sold.toLocaleString() + '</td>' +
                        '<td>' + item.closingStock.toLocaleString() + '</td>' +
                        '<td class="' + (item.variance !== 0 ? 'text-danger' : '') + '">' + item.variance.toLocaleString() + '</td>' +
                        '</tr>'
                    );
                });
            }
        );
    }

    function generateEmployeeReport(startDate, endDate, stationId) {
        $.get('@Url.Action("GenerateEmployeeReport", "Reports")', 
            { startDate, endDate, stationId }, 
            function(data) {
                $('#employeeTableBody').empty();
                data.forEach(function(item) {
                    $('#employeeTableBody').append(
                        '<tr>' +
                        '<td>' + new Date(item.date).toLocaleDateString() + '</td>' +
                        '<td>' + item.employeeName + '</td>' +
                        '<td><span class="badge bg-primary">' + item.role + '</span></td>' +
                        '<td>' + item.station + '</td>' +
                        '<td>' + item.transactionsProcessed + '</td>' +
                        '<td>' + item.totalSales.toLocaleString() + '</td>' +
                        '</tr>'
                    );
                });
            }
        );
    }

    function generateCustomerReport(startDate, endDate) {
        $.get('@Url.Action("GenerateCustomerReport", "Reports")', 
            { startDate, endDate }, 
            function(data) {
                $('#customerTableBody').empty();
                data.forEach(function(item) {
                    $('#customerTableBody').append(
                        '<tr>' +
                        '<td>' + item.customerName + '</td>' +
                        '<td><span class="badge bg-info">' + item.customerType + '</span></td>' +
                        '<td>' + item.totalCars + '</td>' +
                        '<td>' + item.activeSubscriptions + '</td>' +
                        '<td>' + item.totalSpent.toLocaleString() + '</td>' +
                        '<td>' + item.transactionCount + '</td>' +
                        '<td>' + new Date(item.lastTransaction).toLocaleDateString() + '</td>' +
                        '</tr>'
                    );
                });
            }
        );
    }

    function generateFinancialReport(startDate, endDate) {
        $.get('@Url.Action("GenerateFinancialReport", "Reports")', 
            { startDate, endDate }, 
            function(data) {
                $('#financialTableBody').empty();
                data.forEach(function(item) {
                    $('#financialTableBody').append(
                        '<tr>' +
                        '<td>' + new Date(item.date).toLocaleDateString() + '</td>' +
                        '<td>' + item.totalRevenue.toLocaleString() + '</td>' +
                        '<td>' + item.costOfGoods.toLocaleString() + '</td>' +
                        '<td>' + item.grossProfit.toLocaleString() + '</td>' +
                        '<td>' + item.expenses.toLocaleString() + '</td>' +
                        '<td class="' + (item.netProfit > 0 ? 'text-success' : 'text-danger') + '"><strong>' + item.netProfit.toLocaleString() + '</strong></td>' +
                        '<td>' + item.profitMargin.toFixed(1) + '%</td>' +
                        '</tr>'
                    );
                });
            }
        );
    }

    function exportReport() {
        var reportType = $('#reportType').val();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        
        window.location.href = '@Url.Action("ExportReport", "Reports")' + 
            '?reportType=' + reportType + 
            '&startDate=' + startDate + 
            '&endDate=' + endDate;
    }
</script>
}
