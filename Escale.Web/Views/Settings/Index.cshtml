@model Escale.Web.Models.SettingsViewModel
@{
    ViewData["Title"] = "Settings";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-cog me-2"></i>System Settings</h1>
        <p class="text-muted mb-0">Configure your system preferences and company information.</p>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Tabs -->
<div class="card shadow">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="company-tab" data-bs-toggle="tab" data-bs-target="#company" type="button" role="tab">
                    <i class="fas fa-building me-2"></i>Company
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                    <i class="fas fa-server me-2"></i>System
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
                    <i class="fas fa-bell me-2"></i>Notifications
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pricing-tab" data-bs-toggle="tab" data-bs-target="#pricing" type="button" role="tab">
                    <i class="fas fa-tags me-2"></i>Fuel Pricing
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="settingsTabsContent">
            <!-- Company Settings Tab -->
            <div class="tab-pane fade show active" id="company" role="tabpanel">
                <form asp-controller="Settings" asp-action="UpdateCompanySettings" method="post">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyName" class="form-label">Company Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="companyName" name="CompanyName" value="@Model.CompanySettings.CompanyName" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tin" class="form-label">TIN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="tin" name="TIN" value="@Model.CompanySettings.TIN" required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="companyEmail" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="companyEmail" name="Email" value="@Model.CompanySettings.Email" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="companyPhone" class="form-label">Phone <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="companyPhone" name="Phone" value="@Model.CompanySettings.Phone" required />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="companyAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="companyAddress" name="Address" rows="2">@Model.CompanySettings.Address</textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="currency" class="form-label">Currency</label>
                            <select class="form-select" id="currency" name="Currency">
                                <option value="RWF" selected>RWF - Rwandan Franc</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="timeZone" class="form-label">Time Zone</label>
                            <select class="form-select" id="timeZone" name="TimeZone">
                                <option value="Africa/Kigali" selected>Africa/Kigali (CAT)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="logo" class="form-label">Company Logo</label>
                        <input type="file" class="form-control" id="logo" name="Logo" accept="image/*" />
                        <small class="text-muted">Recommended size: 200x200px</small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Company Settings
                    </button>
                </form>
            </div>

            <!-- System Settings Tab -->
            <div class="tab-pane fade" id="system" role="tabpanel">
                <form asp-controller="Settings" asp-action="UpdateSystemSettings" method="post">
                    <h5 class="mb-3">General Settings</h5>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="maintenanceMode" name="MaintenanceMode" @(Model.SystemSettings.MaintenanceMode ? "checked" : "") />
                            <label class="form-check-label" for="maintenanceMode">
                                <strong>Maintenance Mode</strong>
                                <br /><small class="text-muted">When enabled, only administrators can access the system</small>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="sessionTimeout" class="form-label">Session Timeout (minutes)</label>
                        <input type="number" class="form-control" id="sessionTimeout" name="SessionTimeout" value="@Model.SystemSettings.SessionTimeout" />
                    </div>

                    <div class="mb-3">
                        <label for="lowStockThreshold" class="form-label">Low Stock Threshold (%)</label>
                        <input type="number" class="form-control" id="lowStockThreshold" name="LowStockThreshold" value="@Model.SystemSettings.LowStockThreshold" />
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="allowNegativeStock" name="AllowNegativeStock" @(Model.SystemSettings.AllowNegativeStock ? "checked" : "") />
                            <label class="form-check-label" for="allowNegativeStock">
                                Allow Negative Stock
                            </label>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <h5 class="mb-3">Backup Settings</h5>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoBackup" name="AutoBackup" @(Model.SystemSettings.AutoBackup ? "checked" : "") />
                            <label class="form-check-label" for="autoBackup">
                                Enable Auto Backup
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="backupFrequency" class="form-label">Backup Frequency</label>
                        <select class="form-select" id="backupFrequency" name="BackupFrequency">
                            <option value="Hourly" selected="@(Model.SystemSettings.BackupFrequency == "Hourly")">Hourly</option>
                            <option value="Daily" selected="@(Model.SystemSettings.BackupFrequency == "Daily")">Daily</option>
                            <option value="Weekly" selected="@(Model.SystemSettings.BackupFrequency == "Weekly")">Weekly</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-warning" onclick="runBackupNow()">
                            <i class="fas fa-database me-2"></i>Run Backup Now
                        </button>
                    </div>

                    <hr class="my-4" />

                    <h5 class="mb-3">EBM Integration</h5>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableEBM" name="EnableEBM" @(Model.SystemSettings.EnableEBM ? "checked" : "") />
                            <label class="form-check-label" for="enableEBM">
                                <strong>Enable EBM Integration</strong>
                                <br /><small class="text-muted">Connect to Rwanda Revenue Authority's EBM system</small>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="ebmApiUrl" class="form-label">EBM API URL</label>
                        <input type="url" class="form-control" id="ebmApiUrl" name="EBMApiUrl" value="@Model.SystemSettings.EBMApiUrl" placeholder="https://ebm.obr.gov.rw/api" />
                    </div>

                    <div class="mb-3">
                        <label for="ebmApiKey" class="form-label">EBM API Key</label>
                        <input type="password" class="form-control" id="ebmApiKey" name="EBMApiKey" value="@Model.SystemSettings.EBMApiKey" placeholder="••••••••" />
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save System Settings
                    </button>
                </form>
            </div>

            <!-- Notification Settings Tab -->
            <div class="tab-pane fade" id="notifications" role="tabpanel">
                <form asp-controller="Settings" asp-action="UpdateNotificationSettings" method="post">
                    <h5 class="mb-3">Notification Channels</h5>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" name="EmailNotifications" @(Model.NotificationSettings.EmailNotifications ? "checked" : "") />
                            <label class="form-check-label" for="emailNotifications">
                                Enable Email Notifications
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="smsNotifications" name="SMSNotifications" @(Model.NotificationSettings.SMSNotifications ? "checked" : "") />
                            <label class="form-check-label" for="smsNotifications">
                                Enable SMS Notifications
                            </label>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <h5 class="mb-3">Alert Types</h5>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="lowStockAlerts" name="LowStockAlerts" @(Model.NotificationSettings.LowStockAlerts ? "checked" : "") />
                            <label class="form-check-label" for="lowStockAlerts">
                                Low Stock Alerts
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="dailyReports" name="DailyReports" @(Model.NotificationSettings.DailyReports ? "checked" : "") />
                            <label class="form-check-label" for="dailyReports">
                                Daily Reports
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="transactionAlerts" name="TransactionAlerts" @(Model.NotificationSettings.TransactionAlerts ? "checked" : "") />
                            <label class="form-check-label" for="transactionAlerts">
                                Transaction Alerts
                            </label>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <h5 class="mb-3">Contact Information</h5>
                    
                    <div class="mb-3">
                        <label for="notificationEmail" class="form-label">Notification Email</label>
                        <input type="email" class="form-control" id="notificationEmail" name="NotificationEmail" value="@Model.NotificationSettings.NotificationEmail" />
                    </div>

                    <div class="mb-3">
                        <label for="notificationPhone" class="form-label">Notification Phone</label>
                        <input type="tel" class="form-control" id="notificationPhone" name="NotificationPhone" value="@Model.NotificationSettings.NotificationPhone" placeholder="+250788000000" />
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-warning me-2" onclick="testNotification('Email')">
                            <i class="fas fa-envelope me-2"></i>Test Email
                        </button>
                        <button type="button" class="btn btn-warning" onclick="testNotification('SMS')">
                            <i class="fas fa-sms me-2"></i>Test SMS
                        </button>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Notification Settings
                    </button>
                </form>
            </div>

            <!-- Fuel Pricing Tab -->
            <div class="tab-pane fade" id="pricing" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Current Fuel Prices</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#priceModal">
                        <i class="fas fa-plus me-2"></i>Update Prices
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Fuel Type</th>
                                <th>Current Price (RWF/L)</th>
                                <th>Effective Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var price in Model.FuelPrices)
                            {
                                <tr>
                                    <td>
                                        <span class="badge @(price.FuelType == "Petrol" ? "bg-success" : price.FuelType == "Diesel" ? "bg-primary" : "bg-warning")">
                                            @price.FuelType
                                        </span>
                                    </td>
                                    <td><strong>@price.Price.ToString("N0")</strong></td>
                                    <td>@price.EffectiveDate.ToString("yyyy-MM-dd")</td>
                                    <td>
                                        <span class="badge @(price.IsActive ? "bg-success" : "bg-secondary")">
                                            @(price.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="editPrice(@price.Id)" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Price changes will take effect from the specified effective date. Historical prices are maintained for reporting purposes.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Price Update Modal -->
<div class="modal fade" id="priceModal" tabindex="-1" aria-labelledby="priceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priceModalLabel">Update Fuel Price</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="priceForm" asp-controller="Settings" asp-action="UpdateFuelPrice" method="post">
                <div class="modal-body">
                    <input type="hidden" id="priceId" name="Id" />
                    
                    <div class="mb-3">
                        <label for="priceFuelType" class="form-label">Fuel Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="priceFuelType" name="FuelType" required>
                            <option value="Petrol">Petrol</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Super">Super</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="price" class="form-label">Price per Liter (RWF) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="price" name="Price" required step="0.01" />
                    </div>

                    <div class="mb-3">
                        <label for="effectiveDate" class="form-label">Effective Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="effectiveDate" name="EffectiveDate" required />
                    </div>

                    <div class="mb-3">
                        <label for="priceNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="priceNotes" name="Notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Price
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function runBackupNow() {
        if (confirm('This will create a backup of the entire system. Continue?')) {
            $.post('@Url.Action("RunBackup", "Settings")', function() {
                location.reload();
            });
        }
    }

    function testNotification(type) {
        $.post('@Url.Action("TestNotification", "Settings")', { type: type }, function() {
            alert('Test ' + type + ' notification sent! Check your inbox/phone.');
        });
    }

    function editPrice(id) {
        // TODO: Load price data via AJAX
        $('#priceForm').attr('action', '@Url.Action("UpdateFuelPrice", "Settings")');
        $('#priceModalLabel').text('Update Fuel Price');
        $('#priceId').val(id);
        $('#priceModal').modal('show');
    }
</script>
}
