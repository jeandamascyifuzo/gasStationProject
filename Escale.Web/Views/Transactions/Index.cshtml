@model Escale.Web.Models.TransactionFilterViewModel
@{
    ViewData["Title"] = "Transactions";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-receipt me-2"></i>Transactions</h1>
        <p class="text-muted mb-0">View and manage all fuel transactions across stations.</p>
    </div>
</div>

@await Html.PartialAsync("_ApiError")

<!-- Filters -->
<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
    </div>
    <div class="card-body">
        <form asp-controller="Transactions" asp-action="Index" method="get">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="stationId" class="form-label">Station</label>
                    <select class="form-select" id="stationId" name="StationId">
                        <option value="">All Stations</option>
                        @foreach (var station in Model.Stations)
                        {
                            <option value="@station.Id" selected="@(Model.StationId == station.Id)">@station.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-2 mb-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" name="StartDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-2 mb-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="EndDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-3 mb-3">
                    <label for="fuelTypeId" class="form-label">Fuel Type</label>
                    <select class="form-select" id="fuelTypeId" name="FuelTypeId">
                        <option value="">All Fuel Types</option>
                        @foreach (var fuel in Model.FuelTypes)
                        {
                            <option value="@fuel.Id" selected="@(Model.FuelTypeId == fuel.Id)">@fuel.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-2 mb-3">
                    <label for="paymentMethod" class="form-label">Payment</label>
                    <select class="form-select" id="paymentMethod" name="PaymentMethod">
                        <option value="">All Methods</option>
                        <option value="Cash" selected="@(Model.PaymentMethod == "Cash")">Cash</option>
                        <option value="MobileMoney" selected="@(Model.PaymentMethod == "MobileMoney")">Mobile Money</option>
                        <option value="Card" selected="@(Model.PaymentMethod == "Card")">Card</option>
                        <option value="Credit" selected="@(Model.PaymentMethod == "Credit")">Credit</option>
                    </select>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Search
                </button>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-redo me-2"></i>Reset
                </a>
                <a href="@Url.Action("ExportCsv", "Transactions", new { startDate = Model.StartDate?.ToString("yyyy-MM-dd"), endDate = Model.EndDate?.ToString("yyyy-MM-dd") })"
                   class="btn btn-success ms-auto">
                    <i class="fas fa-file-csv me-2"></i>Export CSV
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card shadow mb-4">
    <div class="card-body">
        <div class="table-responsive">
            <table id="transactionsTable" class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Receipt #</th>
                        <th>Station</th>
                        <th>Fuel</th>
                        <th>Liters</th>
                        <th>Price/L (RWF)</th>
                        <th>Subtotal (RWF)</th>
                        <th>VAT (RWF)</th>
                        <th>Total (RWF)</th>
                        <th>Payment</th>
                        <th>Cashier</th>
                        <th>EBM</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var txn in Model.Transactions)
                    {
                        <tr>
                            <td><strong>@txn.ReceiptNumber</strong></td>
                            <td>@txn.StationName</td>
                            <td>@txn.FuelType</td>
                            <td>@txn.Liters.ToString("N2")</td>
                            <td>@txn.PricePerLiter.ToString("N0")</td>
                            <td>@txn.Subtotal.ToString("N0")</td>
                            <td>@txn.VAT.ToString("N0")</td>
                            <td><strong>@txn.Total.ToString("N0")</strong></td>
                            <td>
                                <span class="badge bg-info">@txn.PaymentMethod</span>
                            </td>
                            <td>@txn.CashierName</td>
                            <td>
                                @if (txn.EBMSent)
                                {
                                    <span class="badge bg-success" title="@txn.EBMCode"><i class="fas fa-check"></i> Sent</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pending</span>
                                }
                            </td>
                            <td>@txn.TransactionDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>
                                <a asp-action="Details" asp-route-id="@txn.Id" class="btn btn-sm btn-primary" title="View Receipt">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Transaction pagination" class="mt-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">
                        Showing @((Model.Page - 1) * Model.PageSize + 1)&ndash;@(Math.Min(Model.Page * Model.PageSize, Model.TotalCount)) of @Model.TotalCount transactions
                    </span>
                    <ul class="pagination mb-0">
                        <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                            <a class="page-link" asp-action="Index"
                               asp-route-StationId="@Model.StationId"
                               asp-route-FuelTypeId="@Model.FuelTypeId"
                               asp-route-StartDate="@Model.StartDate?.ToString("yyyy-MM-dd")"
                               asp-route-EndDate="@Model.EndDate?.ToString("yyyy-MM-dd")"
                               asp-route-PaymentMethod="@Model.PaymentMethod"
                               asp-route-Page="@(Model.Page - 1)"
                               asp-route-PageSize="@Model.PageSize">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            var pageNum = i;
                            @if (pageNum >= Model.Page - 2 && pageNum <= Model.Page + 2)
                            {
                                <li class="page-item @(pageNum == Model.Page ? "active" : "")">
                                    <a class="page-link" asp-action="Index"
                                       asp-route-StationId="@Model.StationId"
                                       asp-route-FuelTypeId="@Model.FuelTypeId"
                                       asp-route-StartDate="@Model.StartDate?.ToString("yyyy-MM-dd")"
                                       asp-route-EndDate="@Model.EndDate?.ToString("yyyy-MM-dd")"
                                       asp-route-PaymentMethod="@Model.PaymentMethod"
                                       asp-route-Page="@pageNum"
                                       asp-route-PageSize="@Model.PageSize">@pageNum</a>
                                </li>
                            }
                        }
                        <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" asp-action="Index"
                               asp-route-StationId="@Model.StationId"
                               asp-route-FuelTypeId="@Model.FuelTypeId"
                               asp-route-StartDate="@Model.StartDate?.ToString("yyyy-MM-dd")"
                               asp-route-EndDate="@Model.EndDate?.ToString("yyyy-MM-dd")"
                               asp-route-PaymentMethod="@Model.PaymentMethod"
                               asp-route-Page="@(Model.Page + 1)"
                               asp-route-PageSize="@Model.PageSize">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        }
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        $('#transactionsTable').DataTable({
            pageLength: 50,
            paging: false,
            info: false,
            order: [[11, 'desc']],
            columnDefs: [
                { orderable: false, targets: 12 }
            ]
        });
    });
</script>
}
