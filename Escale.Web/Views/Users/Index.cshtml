@model Escale.Web.Models.UserViewModel
@{
    ViewData["Title"] = "Users";
}

@await Html.PartialAsync("_ApiError")

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 page-header">
    <div>
        <h1 class="h2"><i class="fas fa-users me-2"></i>Users Management</h1>
        <p class="text-muted mb-0">Manage system users, roles, and permissions.</p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openUserModal()">
            <i class="fas fa-user-plus me-2"></i>Add New User
        </button>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-table me-2"></i>All Users</h5>
        <span class="text-muted small">Total: @Model.TotalCount user(s)</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="usersTable" class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Station(s)</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model.Users)
                    {
                        <tr>
                            <td>@user.Username</td>
                            <td>@user.FullName</td>
                            <td>@(user.Email ?? "-")</td>
                            <td>
                                <span class="badge @(user.Role == "Admin" ? "bg-danger" : user.Role == "Manager" ? "bg-primary" : "bg-secondary")">
                                    @user.Role
                                </span>
                            </td>
                            <td>
                                @if (user.AssignedStations != null && user.AssignedStations.Any())
                                {
                                    @string.Join(", ", user.AssignedStations.Select(s => s.Name))
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td>
                                <span class="badge @(user.IsActive ? "bg-success" : "bg-secondary")">
                                    @(user.IsActive ? "Active" : "Disabled")
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="editUser('@user.Id')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="openResetPassword('@user.Id', '@user.Username')" title="Change Password">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button class="btn btn-sm @(user.IsActive ? "btn-secondary" : "btn-success")" onclick="toggleUserStatus('@user.Id')" title="@(user.IsActive ? "Disable" : "Enable")">
                                    <i class="fas fa-@(user.IsActive ? "ban" : "check")"></i>
                                </button>
                                <form asp-action="Delete" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                    <input type="hidden" name="id" value="@user.Id" />
                                    <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (Model.TotalPages > 1)
        {
            <nav aria-label="Users pagination" class="mt-3">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item @(Model.Page <= 1 ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Index", "Users", new { page = Model.Page - 1 })">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.Page ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", "Users", new { page = i })">@i</a>
                        </li>
                    }
                    <li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Index", "Users", new { page = Model.Page + 1 })">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        }
    </div>
</div>

<!-- User Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Add/Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="userForm" asp-controller="Users" asp-action="Create" method="post">
                <div class="modal-body">
                    <input type="hidden" id="userId" name="Id" />

                    <div class="row" id="usernameFieldRow">
                        <div class="col-md-6 mb-3">
                            <label for="userUsername" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userUsername" name="Username" required />
                        </div>
                        <div class="col-md-6 mb-3" id="passwordFieldCol">
                            <label for="userPassword" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="userPassword" name="Password" />
                            <small class="form-text text-muted" id="passwordHint">Required for new users</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userFullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userFullName" name="FullName" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" name="Email" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="userPhone" name="Phone" placeholder="+250788000000" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userRole" class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="userRole" name="Role" onchange="toggleStationField()" required>
                                <option value="">Select Role</option>
                                @foreach (var role in Model.Roles)
                                {
                                    <option value="@role">@role</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row" id="stationFieldRow">
                        <div class="col-md-12 mb-3">
                            <label for="userStationIds" class="form-label">Station(s)</label>
                            <select class="form-select" id="userStationIds" name="StationIds" multiple size="4">
                                @foreach (var station in Model.Stations)
                                {
                                    <option value="@station.Id">@station.Name â€” @station.Location</option>
                                }
                            </select>
                            <small class="form-text text-muted">Hold Ctrl (Cmd on Mac) to select multiple stations</small>
                        </div>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="isActive" name="IsActive" checked />
                        <label class="form-check-label" for="isActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="ResetPassword" method="post">
                <div class="modal-body">
                    <input type="hidden" name="id" id="resetUserId" />
                    <p class="text-muted">Changing password for: <strong id="resetUserName"></strong></p>
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" required />
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="6" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-key me-2"></i>Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        $('#usersTable').DataTable({
            pageLength: 25,
            order: [[1, 'asc']],
            columnDefs: [
                { orderable: false, targets: 6 }
            ]
        });
    });

    var isEditMode = false;

    function openUserModal() {
        isEditMode = false;
        $('#userForm').attr('action', '@Url.Action("Create", "Users")');
        $('#userModalLabel').text('Add New User');
        $('#userForm')[0].reset();
        $('#userId').val('');
        $('#isActive').prop('checked', true);
        // Show username and password fields for create
        $('#usernameFieldRow').show();
        $('#userUsername').attr('required', 'required');
        $('#userPassword').attr('required', 'required');
        $('#passwordHint').text('Required for new users');
        // Clear station multi-select
        $('#userStationIds').val([]);
        toggleStationField();
    }

    function editUser(id) {
        isEditMode = true;
        $('#userForm').attr('action', '@Url.Action("Edit", "Users")');
        $('#userModalLabel').text('Edit User');
        $('#userId').val(id);
        // Hide username and password fields for edit
        $('#usernameFieldRow').hide();
        $('#userUsername').removeAttr('required');
        $('#userPassword').removeAttr('required');

        // Find user data from the table row or load via AJAX
        var users = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Users.Select(u => new {
            u.Id,
            u.Username,
            u.FullName,
            u.Email,
            u.Phone,
            u.Role,
            u.IsActive,
            StationIds = u.AssignedStations.Select(s => s.Id)
        })));

        var user = users.find(function(u) { return u.Id === id; });
        if (user) {
            $('#userFullName').val(user.FullName);
            $('#userEmail').val(user.Email || '');
            $('#userPhone').val(user.Phone || '');
            $('#userRole').val(user.Role);
            $('#isActive').prop('checked', user.IsActive);

            // Set multi-select station values
            var stationIds = user.StationIds || [];
            $('#userStationIds').val(stationIds);

            toggleStationField();
        }

        $('#userModal').modal('show');
    }

    function openResetPassword(id, username) {
        $('#resetUserId').val(id);
        $('#resetUserName').text(username);
        $('#currentPassword').val('');
        $('#newPassword').val('');
        $('#resetPasswordModal').modal('show');
    }

    function toggleUserStatus(id) {
        if (confirm('Are you sure you want to change this user\'s status?')) {
            $.post('@Url.Action("ToggleStatus", "Users")', { id: id }, function() {
                location.reload();
            }).fail(function() {
                alert('Failed to change user status.');
            });
        }
    }

    function toggleStationField() {
        var role = $('#userRole').val();
        if (role === 'Admin') {
            $('#stationFieldRow').hide();
            $('#userStationIds').removeAttr('required');
        } else {
            $('#stationFieldRow').show();
            if (role === 'Manager' || role === 'Cashier') {
                $('#userStationIds').attr('required', 'required');
            }
        }
    }
</script>
}
