<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Escale.mobile.ViewModels"
             xmlns:models="clr-namespace:Escale.mobile.Models"
             x:Class="Escale.mobile.Views.DashboardPage"
             x:DataType="vm:DashboardViewModel"
             Title="Dashboard"
             BackgroundColor="#F8F9FA">

    <RefreshView Command="{Binding RefreshCommand}"
                 IsRefreshing="{Binding IsRefreshing}">
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- Header -->
                <VerticalStackLayout Spacing="5">
                    <Label Text="{Binding UserName, StringFormat='Welcome, {0}'}"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="#1E3A8A"/>
                    <Label Text="{Binding StationName}"
                           FontSize="16"
                           TextColor="#64748B"/>
                </VerticalStackLayout>

                <!-- ========== SKELETON LOADING ========== -->
                <VerticalStackLayout Spacing="15"
                                    IsVisible="{Binding IsLoading}">
                    <!-- Skeleton stat cards -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                        <Border Grid.Column="0" StrokeShape="RoundRectangle 15" BackgroundColor="#E2E8F0" Padding="15" StrokeThickness="0" HeightRequest="90">
                            <VerticalStackLayout Spacing="8">
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="10" WidthRequest="40" CornerRadius="4" HorizontalOptions="Start"/>
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="16" WidthRequest="60" CornerRadius="4" HorizontalOptions="Start"/>
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="8" WidthRequest="30" CornerRadius="4" HorizontalOptions="Start"/>
                            </VerticalStackLayout>
                        </Border>
                        <Border Grid.Column="1" StrokeShape="RoundRectangle 15" BackgroundColor="#E2E8F0" Padding="15" StrokeThickness="0" HeightRequest="90">
                            <VerticalStackLayout Spacing="8">
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="10" WidthRequest="55" CornerRadius="4" HorizontalOptions="Start"/>
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="16" WidthRequest="35" CornerRadius="4" HorizontalOptions="Start"/>
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="8" WidthRequest="30" CornerRadius="4" HorizontalOptions="Start"/>
                            </VerticalStackLayout>
                        </Border>
                        <Border Grid.Column="2" StrokeShape="RoundRectangle 15" BackgroundColor="#E2E8F0" Padding="15" StrokeThickness="0" HeightRequest="90">
                            <VerticalStackLayout Spacing="8">
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="10" WidthRequest="45" CornerRadius="4" HorizontalOptions="Start"/>
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="16" WidthRequest="50" CornerRadius="4" HorizontalOptions="Start"/>
                                <BoxView BackgroundColor="#CBD5E1" HeightRequest="8" WidthRequest="30" CornerRadius="4" HorizontalOptions="Start"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!-- Skeleton quick actions -->
                    <BoxView BackgroundColor="#CBD5E1" HeightRequest="14" WidthRequest="100" CornerRadius="4" HorizontalOptions="Start"/>
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                        <BoxView Grid.Column="0" BackgroundColor="#D1FAE5" HeightRequest="80" CornerRadius="15"/>
                        <BoxView Grid.Column="1" BackgroundColor="#DBEAFE" HeightRequest="80" CornerRadius="15"/>
                    </Grid>

                    <!-- Skeleton recent transactions -->
                    <BoxView BackgroundColor="#CBD5E1" HeightRequest="14" WidthRequest="150" CornerRadius="4" HorizontalOptions="Start"/>
                    <Border StrokeShape="RoundRectangle 10" BackgroundColor="#E2E8F0" Padding="12" StrokeThickness="0" HeightRequest="60"/>
                    <Border StrokeShape="RoundRectangle 10" BackgroundColor="#E2E8F0" Padding="12" StrokeThickness="0" HeightRequest="60"/>
                    <Border StrokeShape="RoundRectangle 10" BackgroundColor="#E2E8F0" Padding="12" StrokeThickness="0" HeightRequest="60"/>
                </VerticalStackLayout>

                <!-- ========== ACTUAL CONTENT ========== -->
                <VerticalStackLayout Spacing="20"
                                    IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">

                    <!-- Summary Cards -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">

                        <!-- Today's Sales -->
                        <Border Grid.Column="0"
                                StrokeShape="RoundRectangle 15"
                                BackgroundColor="White"
                                Padding="15"
                                StrokeThickness="0">
                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.1" Radius="10" Offset="0,2"/>
                            </Border.Shadow>
                            <VerticalStackLayout Spacing="8">
                                <Border StrokeShape="RoundRectangle 6"
                                        BackgroundColor="#D1FAE5"
                                        HeightRequest="28"
                                        WidthRequest="28"
                                        Padding="0">
                                    <Label Text="$"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="#10B981"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>
                                <Label Text="{Binding TodaysSales, StringFormat='{0:N0}'}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#10B981"/>
                                <Label Text="Sales (RWF)"
                                       FontSize="9"
                                       TextColor="#94A3B8"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Transactions Count -->
                        <Border Grid.Column="1"
                                StrokeShape="RoundRectangle 15"
                                BackgroundColor="White"
                                Padding="15"
                                StrokeThickness="0">
                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.1" Radius="10" Offset="0,2"/>
                            </Border.Shadow>
                            <VerticalStackLayout Spacing="8">
                                <Border StrokeShape="RoundRectangle 6"
                                        BackgroundColor="#DBEAFE"
                                        HeightRequest="28"
                                        WidthRequest="28"
                                        Padding="0">
                                    <Label Text="#"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="#1E3A8A"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>
                                <Label Text="{Binding TransactionCount}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#1E3A8A"/>
                                <Label Text="Today"
                                       FontSize="9"
                                       TextColor="#94A3B8"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Average Sale -->
                        <Border Grid.Column="2"
                                StrokeShape="RoundRectangle 15"
                                BackgroundColor="White"
                                Padding="15"
                                StrokeThickness="0">
                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.1" Radius="10" Offset="0,2"/>
                            </Border.Shadow>
                            <VerticalStackLayout Spacing="8">
                                <Border StrokeShape="RoundRectangle 6"
                                        BackgroundColor="#FEF3C7"
                                        HeightRequest="28"
                                        WidthRequest="28"
                                        Padding="0">
                                    <Label Text="~"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="#F59E0B"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>
                                <Label Text="{Binding AverageSale, StringFormat='{0:N0}'}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#F59E0B"/>
                                <Label Text="Avg (RWF)"
                                       FontSize="9"
                                       TextColor="#94A3B8"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!-- Low Stock Alert -->
                    <Border StrokeShape="RoundRectangle 15"
                            BackgroundColor="#FEF3C7"
                            Padding="20"
                            StrokeThickness="0"
                            IsVisible="{Binding HasLowStock}">
                        <VerticalStackLayout Spacing="10">
                            <HorizontalStackLayout Spacing="8">
                                <Border StrokeShape="RoundRectangle 6"
                                        BackgroundColor="#FDE68A"
                                        HeightRequest="24"
                                        WidthRequest="24"
                                        Padding="0">
                                    <Label Text="!"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="#92400E"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>
                                <Label Text="Low Stock Alert"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#92400E"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                            <CollectionView ItemsSource="{Binding LowStockAlerts}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:StockAlert">
                                        <Label>
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding FuelType}" FontAttributes="Bold"/>
                                                    <Span Text=": "/>
                                                    <Span Text="{Binding CurrentLevel, StringFormat='{0:N0} L'}"/>
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Quick Actions -->
                    <Label Text="Quick Actions"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="#1E3A8A"
                           Margin="0,5,0,0"/>

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                        <Button Grid.Column="0"
                                Text="New Sale"
                                Command="{Binding NewSaleCommand}"
                                BackgroundColor="#10B981"
                                TextColor="White"
                                FontSize="16"
                                FontAttributes="Bold"
                                HeightRequest="80"
                                CornerRadius="15"/>

                        <Button Grid.Column="1"
                                Text="Check Stock"
                                Command="{Binding CheckStockCommand}"
                                BackgroundColor="#3B82F6"
                                TextColor="White"
                                FontSize="16"
                                FontAttributes="Bold"
                                HeightRequest="80"
                                CornerRadius="15"/>
                    </Grid>

                    <!-- Recent Transactions -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="Recent Transactions"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#1E3A8A"
                               VerticalOptions="Center"/>
                        <Label Grid.Column="1"
                               Text="View All"
                               FontSize="14"
                               TextColor="#3B82F6"
                               VerticalOptions="Center">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ViewTransactionsCommand}"/>
                            </Label.GestureRecognizers>
                        </Label>
                    </Grid>

                    <CollectionView ItemsSource="{Binding RecentTransactions}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:RecentTransaction">
                                <Border StrokeShape="RoundRectangle 10"
                                        BackgroundColor="White"
                                        Padding="12"
                                        Margin="0,0,0,8"
                                        StrokeThickness="0">
                                    <Border.Shadow>
                                        <Shadow Brush="Black" Opacity="0.05" Radius="6" Offset="0,2"/>
                                    </Border.Shadow>
                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                        <Border Grid.Column="0"
                                                StrokeShape="RoundRectangle 8"
                                                BackgroundColor="#EEF2FF"
                                                HeightRequest="40"
                                                WidthRequest="40"
                                                Padding="0">
                                            <Label Text="F"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="#1E3A8A"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"/>
                                        </Border>
                                        <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                            <Label Text="{Binding FuelType}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="#1E293B"/>
                                            <Label Text="{Binding TransactionDate, StringFormat='{0:HH:mm}'}"
                                                   FontSize="12"
                                                   TextColor="#94A3B8"/>
                                        </VerticalStackLayout>
                                        <VerticalStackLayout Grid.Column="2" Spacing="2" VerticalOptions="Center">
                                            <Label Text="{Binding Total, StringFormat='RWF {0:N0}'}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="#10B981"
                                                   HorizontalOptions="End"/>
                                            <Label Text="{Binding Liters, StringFormat='{0:F1} L'}"
                                                   FontSize="12"
                                                   TextColor="#94A3B8"
                                                   HorizontalOptions="End"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <Label Text="No transactions today"
                                   FontSize="14"
                                   TextColor="#94A3B8"
                                   HorizontalOptions="Center"
                                   Margin="0,10"/>
                        </CollectionView.EmptyView>
                    </CollectionView>

                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>

</ContentPage>
